# ðŸ³ Ejecutar la aplicaciÃ³n
```bash
# Construir la imagen
docker build -t dash-app .

# Ejecutar el contenedor
docker run -p 8050:8050 dash-app
```
**Una vez hecho esto, entrar en *localhost:8050*** (Independientemente del texto mostrado en el terminal)

# ðŸ–¥ï¸ AnÃ¡lisis del Dashboard
La siguiente secciÃ³n ofrece informaciÃ³n acerca de cÃ³mo interactuar con el dashboard. 

El dashboard estÃ¡ dividido en varias secciones, cada una de las cuales pretende ofrecer informaciÃ³n sobre una dimensiÃ³n del negocio de Uber.

## ðŸš— Viajes
Debido a la complejidad de esta vista, hay un botÃ³n de informaciÃ³n (â„¹ï¸) que indica brevemente cÃ³mo interactuar con los grÃ¡ficos y el mapa.  
A continuaciÃ³n se ofrecen indicaciones mÃ¡s detalladas con el objetivo de aprovechar completamente las funcionalidades de la interfaz.

### ðŸ—ºï¸ Mapa de trayectorias
InteractÃºa con:

* **BotÃ³n â€œVer salidas/llegadasâ€**  
    - Permite mostrar en el mapa las **salidas** (lugares donde el conductor ha recogido al pasajero) o **llegadas** (lugares donde el pasajero ha abandonado el vehÃ­culo).

* **Selector de hora de inicio y hora fin**  
    - Tanto los grÃ¡ficos laterales como el mapa se actualizarÃ¡n con los viajes que hayan comenzado entre las horas elegidas.

* **Click en un icono de coche**  
    - Filtra el mapa para mostrar solo el viaje asociado a ese icono (salida y llegada).  
    - El mapa ajustarÃ¡ el zoom automÃ¡ticamente para mostrar ambos puntos.  
    - Si se vuelve a hacer click sobre cualquiera de los coches, se mostrarÃ¡ informaciÃ³n detallada del viaje: nÃºmero de pasajeros, dinero total ganado, duraciÃ³n y distancia.  
    - Para volver a ver todos los iconos, pulsa nuevamente el botÃ³n *Mostrar salidas/llegadas*.

### ðŸ§³ Plots sobre los viajes
Los plots del tercio derecho **reaccionan dinÃ¡micamente** a los viajes mostrados.  
Cualquier interacciÃ³n en el mapa (zoom, desplazamiento, cambio de hora, etc.) actualiza estos grÃ¡ficos.

Se muestran tres grÃ¡ficos principales:
* **Treemap** â†’ Cantidad de viajes realizados segÃºn el nÃºmero de pasajeros.  
* **Violin plots** â†’ DistribuciÃ³n del tiempo y la distancia de los viajes.

Estos grÃ¡ficos permiten analizar la **frecuencia y dispersiÃ³n** de los viajes visibles en ese momento en pantalla.



## ðŸ¢ Distritos
Esta pestaÃ±a muestra informaciÃ³n sobre la **distancia y el tiempo de los viajes** realizados **entre distritos** y **dentro del mismo distrito**.  
Los datos se presentan mediante los siguientes grÃ¡ficos:

* **Heatmaps de tiempo y distancia**  
    - Muestran la media de tiempo y distancia de los viajes entre cada par de distritos.  
    - Los valores mÃ¡s altos se representan con colores mÃ¡s intensos, facilitando la identificaciÃ³n de trayectos mÃ¡s largos o lentos.

* **Doble Radial Map (tiempo y distancia)**  
    - Permite comparar visualmente las conexiones de cada distrito con el resto.  
    - Un mapa radial muestra la distancia media, y el otro el tiempo medio de viaje.  
    - Al pasar el cursor, se resalta el valor especÃ­fico del trayecto.

## ðŸ’³ Ventana de Pagos
Esta secciÃ³n permite explorar la informaciÃ³n relacionada con los **mÃ©todos de pago** y el **flujo econÃ³mico**.

* **Waffle plot de tipos de pago**  
    - Muestra los tipos de pago utilizados, divididos en 4 rangos de precio.  
    - Al hacer *hover*, se muestra el **porcentaje** que representa ese tipo de pago dentro del rango.

* **Sankey plot del flujo de dinero**  
    - Representa el flujo desde las fuentes de ingreso (**ganancia base, propina y extras**) hasta las categorÃ­as finales (**total, recargo y peajes**).  
    - Al pasar el cursor sobre un enlace o nodo, se muestra el **monto exacto** correspondiente.

---

## ðŸ“ˆ EvoluciÃ³n del negocio
La tabla **EvoluciÃ³n** muestra cÃ³mo cambian a lo largo de las horas las distintas caracterÃ­sticas clave del negocio:

* NÃºmero de pasajeros.
* Ingresos totales.
* Minutos totales de viaje.
* Distancia total recorrida.

Estos datos permiten identificar los **picos de demanda** y los periodos de **mayor actividad**.

---

## ðŸŒ¿ Emisiones de COâ‚‚
La pestaÃ±a de emisiones permite visualizar el impacto ambiental de los viajes de Uber en la ciudad.

* **Tabla de emisiones totales por hora**  
    - Muestra los kilogramos totales de COâ‚‚ emitidos en cada franja horaria.  
    - Al hacer *hover*, se muestra el valor exacto en kg para esa hora.

* **GrÃ¡fico de emisiones de COâ‚‚ por distrito**  
    - Permite analizar el COâ‚‚ emitido por viajes que comienzan en un distrito concreto.  
    - Se puede filtrar por **rango de hora** y **distrito de salida**.  
    - AdemÃ¡s, se puede alternar entre visualizar las **emisiones totales por viaje** o las **emisiones por pasajero**.

---

# ðŸ§© RecolecciÃ³n y Procesamiento de Datos
El procesamiento de los datos se realizÃ³ en el notebook **`data_preprocessing.ipynb`**, a partir del dataset pÃºblico de **[praveenluppunda/uber-dataset](https://github.com/praveenluppunda/uber-dataset)**.

### ðŸ“¦ Limpieza y filtrado de datos
1. **EliminaciÃ³n de coordenadas invÃ¡lidas:**  
   Se eliminaron todas las filas con coordenadas (0,0) por no corresponder a ubicaciones reales.

2. **AsignaciÃ³n geoespacial de distritos:**  
   Se implementÃ³ un proceso de uniÃ³n espacial (*spatial join*) entre las coordenadas de inicio y fin del viaje y los lÃ­mites geogrÃ¡ficos de los distritos de Nueva York.  
   Este procedimiento permite identificar a quÃ© **borough** pertenece cada punto.  
   *(Ver cÃ³digo en la secciÃ³n de procesamiento geoespacial).*

3. **TransformaciÃ³n de variables categÃ³ricas:**  
   - `RatecodeID` y `payment_type` se transformaron de valores numÃ©ricos a categorÃ­as descriptivas (p. ej. *Standard rate*, *Credit card*, *Cash*, etc.).  
   - Se eliminÃ³ la columna `store_and_fwd_flag` por no aportar informaciÃ³n relevante.

4. **EliminaciÃ³n de outliers extremos:**  
   Se eliminaron Ãºnicamente los viajes con valores de **distancia o duraciÃ³n excesivos**, considerados fuera del alcance del anÃ¡lisis (basado en el rango intercuartÃ­lico, con un umbral de 3Ã—IQR).

---

## ðŸŒ Procesamiento Geoespacial
El siguiente fragmento muestra cÃ³mo se asignan los distritos a las coordenadas de inicio y fin de cada viaje mediante un proceso de uniÃ³n espacial sobre los lÃ­mites oficiales de los *boroughs* de Nueva York:

```python
# --- PROCESAMIENTO GEOESPACIAL ---
def assign_borough_from_geometry(df: pd.DataFrame, lat_col: str, lon_col: str, output_col: str) -> pd.DataFrame:
    """
    Asigna el distrito (borough) a las coordenadas usando una uniÃ³n espacial.
    """
    print(f"\n--- Iniciando asignaciÃ³n de distrito para {output_col} ---")
    nyc_boundaries_url = "https://data.cityofnewyork.us/resource/gthc-hcne.geojson"
    try:
        boroughs_gdf = gpd.read_file(nyc_boundaries_url)
        boroughs_gdf.rename(columns={'boroname': 'borough_name_geo'}, inplace=True)
        boroughs_gdf = boroughs_gdf.to_crs(epsg=4326)
    except Exception as e:
        print(f"Error al cargar lÃ­mites de distritos: {e}")
        return df
    geometry = [Point(xy) for xy in zip(df[lon_col], df[lat_col])]
    points_gdf = gpd.GeoDataFrame(df, geometry=geometry, crs="EPSG:4326")
    join_result = gpd.sjoin(points_gdf, boroughs_gdf[['borough_name_geo', 'geometry']], how="left", predicate="within")
    df[output_col] = join_result['borough_name_geo'].reindex(df.index).fillna('Out of NYC/Unknown')
    return df

```

---

## ðŸ’¨ CÃ¡lculo de Emisiones de COâ‚‚
Las emisiones se estimaron con base en metodologÃ­as **EMEP/COPERT** y factores de conversiÃ³n **DEFRA (UK)**.

**Resumen del cÃ¡lculo:**

1. **Consumo de combustible dependiente de la velocidad:**
   $$
   \text{consumo\_combustible\_g\_por\_km} = 81.1 - 1.014 \cdot V + 0.0068 \cdot V^2
   $$
   donde \(V\) es la velocidad media del viaje (km/h).

2. **ConversiÃ³n de consumo a litros por kilÃ³metro:**
   $$
   \text{litros\_por\_km} = \frac{\text{consumo\_g\_por\_km} / 1000}{\rho_{\text{gasolina}}}
   $$
   con \(\rho_{\text{gasolina}} \approx 0.74\, \text{kg/L}\).

3. **ConversiÃ³n a emisiones de COâ‚‚:**
   $$
   \text{kgCO2\_por\_km} = \text{litros\_por\_km} \times 2.0844
   $$

4. **Emisiones totales y por pasajero:**
   $$
   \text{emisiones\_viaje} = \text{kgCO2\_por\_km} \times \text{distancia\_km}
   $$
   $$
   \text{emisiones\_por\_pasajero} = \frac{\text{emisiones\_viaje}}{\max(1, \text{nÂº\_pasajeros})}
   $$

```python
# --- ESTIMACIÃ“N DE CO2 ---
FUEL_DENSITY_KG_PER_L = 0.74
CO2_PER_LITRE_KG = 2.0844

def fuel_g_per_km_emep_petrol(V_kmh: float) -> float:
    if np.isnan(V_kmh) or V_kmh <= 0:
        return np.nan
    V = float(np.clip(V_kmh, 10.0, 130.0))
    return 81.1 - 1.014 * V + 0.0068 * V**2

def co2_per_km_from_speed(V_kmh: float) -> float:
    fuel_g_km = fuel_g_per_km_emep_petrol(V_kmh)
    if np.isnan(fuel_g_km):
        return np.nan
    fuel_kg_km = fuel_g_km / 1000.0
    fuel_l_km = fuel_kg_km / FUEL_DENSITY_KG_PER_L
    return fuel_l_km * CO2_PER_LITRE_KG

def estimate_co2_dataframe(df: pd.DataFrame,
                           distance_col='trip_distance_km',
                           minutes_col='trip_minutes',
                           passengers_col='passenger_count'):
    df = df.copy()
    df['avg_speed_kmh'] = df[distance_col] / (df[minutes_col] / 60.0)
    df['co2_kg_per_km'] = df['avg_speed_kmh'].apply(co2_per_km_from_speed)
    df['co2_kg_trip'] = df['co2_kg_per_km'] * df[distance_col]
    df['passenger_count_safe'] = df[passengers_col].replace({0:1}).fillna(1)
    df['co2_kg_per_passenger'] = df['co2_kg_trip'] / df['passenger_count_safe']
    return df

```


## âš’ï¸ Transformaciones finales
Antes de la carga de datos al dashboard, se aplicaron las siguientes transformaciones adicionales:
- ConversiÃ³n de categorÃ­as (`RatecodeID`, `payment_type`).
- EliminaciÃ³n de columnas no necesarias.
- Filtrado de outliers extremos.
- CÃ¡lculo final de columnas derivadas:
  - `avg_speed_kmh`
  - `co2_kg_trip`
  - `co2_kg_per_passenger`

```python
# --- TRANSFORMACIONES FINALES ---
ratecode_map = {
    1: "Standard rate",
    2: "JFK",
    3: "Newark",
    4: "Nassau or Westchester",
    5: "Negotiated fare",
    6: "Group ride",
    99: "Null/unknown"
}
if 'RatecodeID' in df.columns:
    df['RatecodeID'] = df['RatecodeID'].map(ratecode_map)

payment_type_map = {
    0: "Flex Fare trip",
    1: "Credit card",
    2: "Cash",
    3: "No charge",
    4: "Dispute",
    5: "Unknown",
    6: "Voided trip"
}
if 'payment_type' in df.columns:
    df['payment_type'] = df['payment_type'].map(payment_type_map)

if 'store_and_fwd_flag' in df.columns:
    df = df.drop(columns=['store_and_fwd_flag'])

# Filtrado de outliers extremos
nrows = df.shape[0]
for col in ['trip_distance_km', 'trip_minutes']:
    Q1 = df[col].quantile(0.25)
    Q3 = df[col].quantile(0.75)
    IQR = Q3 - Q1
    lower_bound = Q1 - 3 * IQR
    upper_bound = Q3 + 3 * IQR
    df = df[(df[col] >= lower_bound) & (df[col] <= upper_bound)]
print(f"{nrows - df.shape[0]} filas eliminadas")

```



## ðŸ§¾ Resumen
El pipeline completo permite obtener un dataset **limpio, enriquecido y ambientalmente contextualizado**, que sustenta el dashboard interactivo de Uber.  
El resultado final combina datos operativos, econÃ³micos y ecolÃ³gicos para ofrecer una visiÃ³n integral del negocio.



## ðŸ“š Referencias
- Agencia Europea del Medio Ambiente (EMEP/COPERT)  
- DEFRA (UK Department for Environment, Food and Rural Affairs)  
- Dataset base: [praveenluppunda/uber-dataset](https://github.com/praveenluppunda/uber-dataset)  
- Datos geogrÃ¡ficos: [NYC Open Data â€“ Borough Boundaries](https://data.cityofnewyork.us/resource/gthc-hcne.geojson)


